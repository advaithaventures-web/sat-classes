<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAT by Raj - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a2332 0%, #2c3e50 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            color: #1a2332;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #B8860B;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #B8860B;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #9a7209;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-xs {
            padding: 4px 8px;
            font-size: 11px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: #1a2332;
            color: white;
            padding: 20px 0;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #2c3e50;
        }

        .sidebar-header h2 {
            color: #B8860B;
            font-size: 20px;
        }

        .sidebar-header p {
            color: #aaa;
            font-size: 12px;
            margin-top: 5px;
        }

        .nav-menu {
            list-style: none;
            padding: 20px 0;
        }

        .nav-menu li {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-menu li:hover, .nav-menu li.active {
            background: #2c3e50;
            border-left-color: #B8860B;
        }

        .nav-menu li span {
            margin-left: 10px;
        }

        .logout-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            padding: 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .main-content {
            margin-left: 250px;
            padding: 30px;
            min-height: 100vh;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h1 {
            color: #1a2332;
            font-size: 28px;
        }

        .page-header p {
            color: #666;
            margin-top: 5px;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #1a2332;
            margin-top: 10px;
        }

        /* Tables */
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            color: #1a2332;
            font-size: 18px;
        }

        .card-body {
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-secondary {
            background: #e2e3e5;
            color: #383d41;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-lg {
            max-width: 800px;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #1a2332;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Filter bar */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 200px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* Course Progress Styles */
        .class-progress-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .class-progress-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .class-progress-card.unlocked {
            border-color: #B8860B;
            background: #fffbf0;
        }

        .class-progress-card.completed {
            border-color: #28a745;
            background: #f0fff4;
        }

        .class-progress-card.locked {
            border-color: #ddd;
            background: #f5f5f5;
            opacity: 0.7;
        }

        .class-progress-card .class-num {
            font-size: 24px;
            font-weight: bold;
            color: #1a2332;
        }

        .class-progress-card .class-status {
            font-size: 12px;
            margin-top: 5px;
            color: #666;
        }

        .class-progress-card .class-actions {
            margin-top: 10px;
        }

        .unlock-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .unlock-btn:hover {
            background: #218838;
        }

        .lock-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .lock-btn:hover {
            background: #c82333;
        }

        /* Homework drills table */
        .drills-summary {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .drill-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .drill-badge.untimed {
            background: #d4edda;
            color: #155724;
        }

        .drill-badge.timed {
            background: #fff3cd;
            color: #856404;
        }

        .drill-badge.test {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <h1>üéì SAT by Raj</h1>
            <p>Admin Panel Login</p>
            <div class="error-message" id="loginError"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password">
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>üéì SAT by Raj</h2>
                <p>Admin Panel</p>
            </div>
            <ul class="nav-menu">
                <li class="active" data-section="overview">üìä <span>Overview</span></li>
                <li data-section="students">üë• <span>Students</span></li>
                <li data-section="course">üìö <span>Course Progress</span></li>
                <li data-section="questions">üìù <span>Questions</span></li>
                <li data-section="attempts">üìà <span>Practice History</span></li>
            </ul>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </nav>

        <main class="main-content">
            <!-- Overview Section -->
            <section class="section active" id="overviewSection">
                <div class="page-header">
                    <h1>Dashboard Overview</h1>
                    <p>Welcome back! Here's what's happening.</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Students</h3>
                        <div class="number" id="totalStudents">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Students</h3>
                        <div class="number" id="activeStudents">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Questions</h3>
                        <div class="number" id="totalQuestions">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Attempts</h3>
                        <div class="number" id="totalAttempts">-</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2>Recent Activity</h2>
                    </div>
                    <div class="card-body" id="recentActivity">
                        <p class="loading">Loading...</p>
                    </div>
                </div>
            </section>

            <!-- Students Section -->
            <section class="section" id="studentsSection">
                <div class="page-header">
                    <h1>Manage Students</h1>
                    <p>Add, edit, or remove student accounts.</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2>All Students</h2>
                        <button class="btn btn-success" onclick="showAddStudentModal()">+ Add Student</button>
                    </div>
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Course Progress</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <tr><td colspan="6" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Course Progress Section -->
            <section class="section" id="courseSection">
                <div class="page-header">
                    <h1>Course Progress</h1>
                    <p>View and manage student course progress. Unlock/lock classes manually.</p>
                </div>

                <!-- Student Selector -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label><strong>Select Student:</strong></label>
                            <select id="courseStudentSelector" onchange="loadStudentCourseProgress()" style="max-width: 400px;">
                                <option value="">-- Choose a student --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Course Overview (all students) -->
                <div class="card" id="courseOverviewCard">
                    <div class="card-header">
                        <h2>All Students Course Overview</h2>
                    </div>
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Current Class</th>
                                    <th>Classes Completed</th>
                                    <th>HW Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="courseOverviewBody">
                                <tr><td colspan="5" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Individual Student Course Progress -->
                <div id="studentCourseDetail" style="display: none;">
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <h2>üìö Class Progress for <span id="selectedStudentName"></span></h2>
                        </div>
                        <div class="card-body">
                            <p style="margin-bottom: 15px; color: #666;">Click "Unlock" to manually give access to a class, or "Lock" to remove access.</p>
                            <div class="class-progress-grid" id="classProgressGrid">
                                <!-- Class cards will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- Homework Drills Detail -->
                    <div class="card">
                        <div class="card-header">
                            <h2>üìù Homework Drill Details</h2>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Class</th>
                                        <th>Section</th>
                                        <th>Type</th>
                                        <th>Score</th>
                                        <th>Time</th>
                                        <th>Completed</th>
                                    </tr>
                                </thead>
                                <tbody id="homeworkDrillsBody">
                                    <tr><td colspan="6" class="empty-state">No homework drills completed yet</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Questions Section -->
            <section class="section" id="questionsSection">
                <div class="page-header">
                    <h1>Manage Questions</h1>
                    <p>Add, edit, or remove practice questions.</p>
                </div>
                <div class="filter-bar">
                    <select id="topicFilter" onchange="loadQuestions()">
                        <option value="">All Topics</option>
                    </select>
                    <select id="setTypeFilter" onchange="loadQuestions()">
                        <option value="">All Sets</option>
                        <option value="untimed">Untimed</option>
                        <option value="timed">Timed</option>
                    </select>
                </div>
                
                <!-- Bulk Upload Section -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h2>üì§ Bulk Upload Questions</h2>
                        <a href="#" class="btn btn-secondary" id="downloadTemplateBtn" onclick="downloadTemplate(event)">üì• Download Template</a>
                    </div>
                    <div class="card-body">
                        <p style="margin-bottom: 15px; color: #666;">Upload an Excel file (.xlsx) with multiple questions. The file should have columns: topic_name, set_type, question_number, passage, question_text, option_a, option_b, option_c, option_d, correct_answer, explanation</p>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <input type="file" id="bulkUploadFile" accept=".xlsx,.xls" style="flex: 1;">
                            <button class="btn btn-success" onclick="bulkUpload()">Upload & Import</button>
                        </div>
                        <div id="uploadStatus" style="margin-top: 15px; display: none;"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>Questions (<span id="questionCount">0</span>)</h2>
                        <button class="btn btn-success" onclick="showAddQuestionModal()">+ Add Question</button>
                    </div>
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Topic</th>
                                    <th>Set</th>
                                    <th>#</th>
                                    <th>Question</th>
                                    <th>Answer</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="questionsTableBody">
                                <tr><td colspan="6" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Attempts Section -->
            <section class="section" id="attemptsSection">
                <div class="page-header">
                    <h1>Practice History</h1>
                    <p>View topic-based practice attempts (from "Practice Topics" tab).</p>
                </div>
                
                <!-- Student Selector -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label><strong>Filter by Student:</strong></label>
                            <select id="studentSelector" onchange="loadStudentProgress()" style="max-width: 400px;">
                                <option value="">-- All Students --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Student Overview (hidden until student selected) -->
                <div id="studentOverview" style="display: none;">
                    <!-- Stats Cards -->
                    <div class="stats-row" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #1a2332;" id="statTotalAttempts">0</div>
                            <div style="color: #666; font-size: 14px;">Total Attempts</div>
                        </div>
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #28a745;" id="statAvgScore">0%</div>
                            <div style="color: #666; font-size: 14px;">Average Score</div>
                        </div>
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #B8860B;" id="statTopicsStarted">0/10</div>
                            <div style="color: #666; font-size: 14px;">Topics Started</div>
                        </div>
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #17a2b8;" id="statBestScore">0/15</div>
                            <div style="color: #666; font-size: 14px;">Best Score</div>
                        </div>
                    </div>

                    <!-- Topic-wise Progress -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <h2>üìä Topic-wise Progress</h2>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Topic</th>
                                        <th>Untimed Best</th>
                                        <th>Untimed Attempts</th>
                                        <th>Timed Best</th>
                                        <th>Timed Attempts</th>
                                        <th>Progress</th>
                                    </tr>
                                </thead>
                                <tbody id="topicProgressBody">
                                    <tr><td colspan="6" class="empty-state">Select a student to view progress</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Recent Attempts -->
                    <div class="card">
                        <div class="card-header">
                            <h2>üìù Recent Attempts</h2>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Topic</th>
                                        <th>Set</th>
                                        <th>Score</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentAttemptsBody">
                                    <tr><td colspan="5" class="empty-state">No attempts yet</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- All Attempts (shown when no student selected) -->
                <div class="card" id="allAttemptsCard">
                    <div class="card-header">
                        <h2>All Practice Attempts</h2>
                    </div>
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Topic</th>
                                    <th>Set</th>
                                    <th>Score</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attemptsTableBody">
                                <tr><td colspan="6" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add/Edit Student Modal -->
    <div class="modal-overlay" id="studentModal">
        <div class="modal">
            <h2 id="studentModalTitle">Add Student</h2>
            <form id="studentForm">
                <input type="hidden" id="studentId">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="studentName" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="studentEmail" required>
                </div>
                <div class="form-group">
                    <label>Password <span id="passwordHint">(required)</span></label>
                    <input type="password" id="studentPassword">
                </div>
                <div class="form-group" id="statusGroup" style="display:none;">
                    <label>Status</label>
                    <select id="studentStatus">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('studentModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Question Modal -->
    <div class="modal-overlay" id="questionModal">
        <div class="modal">
            <h2 id="questionModalTitle">Add Question</h2>
            <form id="questionForm">
                <input type="hidden" id="questionId">
                <div class="form-group">
                    <label>Topic</label>
                    <select id="questionTopic" required></select>
                </div>
                <div class="form-group">
                    <label>Set Type</label>
                    <select id="questionSetType" required>
                        <option value="untimed">Untimed</option>
                        <option value="timed">Timed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Question Number (1-100)</label>
                    <input type="number" id="questionNumber" min="1" max="100" required>
                </div>
                <div class="form-group">
                    <label>Passage (optional)</label>
                    <textarea id="questionPassage" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Question Text</label>
                    <textarea id="questionText" rows="2" required></textarea>
                </div>
                <div class="form-group">
                    <label>Option A</label>
                    <input type="text" id="optionA" required>
                </div>
                <div class="form-group">
                    <label>Option B</label>
                    <input type="text" id="optionB" required>
                </div>
                <div class="form-group">
                    <label>Option C</label>
                    <input type="text" id="optionC" required>
                </div>
                <div class="form-group">
                    <label>Option D</label>
                    <input type="text" id="optionD" required>
                </div>
                <div class="form-group">
                    <label>Correct Answer</label>
                    <select id="correctAnswer" required>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Explanation</label>
                    <textarea id="questionExplanation" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('questionModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Attempt Modal -->
    <div class="modal-overlay" id="attemptModal">
        <div class="modal">
            <h2>Attempt Details</h2>
            <div id="attemptDetails"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('attemptModal')">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://satbyraj-backend.onrender.com/api';
        let token = localStorage.getItem('adminToken');
        let topics = [];
        let allStudentsList = [];

        // Check if already logged in
        if (token) {
            showDashboard();
        }

        // Login form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Login failed');
                }

                if (data.user.role !== 'admin') {
                    throw new Error('Admin access required');
                }

                localStorage.setItem('adminToken', data.token);
                localStorage.setItem('adminUser', JSON.stringify(data.user));
                token = data.token;
                showDashboard();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            token = null;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
        });

        // Navigation
        document.querySelectorAll('.nav-menu li').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-menu li').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                const section = item.dataset.section;
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(section + 'Section').classList.add('active');

                // Load data for section
                if (section === 'students') loadStudents();
                if (section === 'course') loadCourseOverview();
                if (section === 'questions') loadQuestions();
                if (section === 'attempts') loadAttempts();
            });
        });

        async function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            await loadTopics();
            await loadStudentsList();
            loadOverview();
        }

        async function apiCall(endpoint, options = {}) {
            const res = await fetch(`${API_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            });
            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.error || 'API error');
            }
            return res.json();
        }

        async function loadStudentsList() {
            try {
                const users = await apiCall('/admin/users');
                allStudentsList = users.filter(u => u.role !== 'admin');
                
                // Populate all student selectors
                const selectors = ['courseStudentSelector', 'studentSelector'];
                selectors.forEach(id => {
                    const selector = document.getElementById(id);
                    if (selector) {
                        const firstOption = id === 'studentSelector' ? '<option value="">-- All Students --</option>' : '<option value="">-- Choose a student --</option>';
                        selector.innerHTML = firstOption + 
                            allStudentsList.map(s => `<option value="${s.id}">${s.name} (${s.email})</option>`).join('');
                    }
                });
            } catch (error) {
                console.error('Failed to load students list:', error);
            }
        }

        async function loadTopics() {
            try {
                topics = await apiCall('/admin/topics');
                
                // Populate topic filters
                const topicFilter = document.getElementById('topicFilter');
                const questionTopic = document.getElementById('questionTopic');
                
                topicFilter.innerHTML = '<option value="">All Topics</option>';
                questionTopic.innerHTML = '';
                
                topics.forEach(t => {
                    topicFilter.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                    questionTopic.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                });
            } catch (error) {
                console.error('Failed to load topics:', error);
            }
        }

        async function loadOverview() {
            try {
                const [users, questions, attempts] = await Promise.all([
                    apiCall('/admin/users'),
                    apiCall('/admin/questions'),
                    apiCall('/admin/attempts')
                ]);

                const students = users.filter(u => u.role !== 'admin');
                const activeStudents = students.filter(u => u.is_active);

                document.getElementById('totalStudents').textContent = students.length;
                document.getElementById('activeStudents').textContent = activeStudents.length;
                document.getElementById('totalQuestions').textContent = questions.length;
                document.getElementById('totalAttempts').textContent = attempts.length;

                // Recent activity
                const recentAttempts = attempts.slice(0, 5);
                const activityHtml = recentAttempts.length > 0 
                    ? `<table>
                        <thead><tr><th>Student</th><th>Topic</th><th>Score</th><th>Date</th></tr></thead>
                        <tbody>
                            ${recentAttempts.map(a => `
                                <tr>
                                    <td>${a.student_name}</td>
                                    <td>${a.topic_name}</td>
                                    <td>${a.score !== null ? `${a.score}/15` : 'In Progress'}</td>
                                    <td>${new Date(a.started_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`
                    : '<p class="empty-state">No attempts yet</p>';
                
                document.getElementById('recentActivity').innerHTML = activityHtml;
            } catch (error) {
                console.error('Failed to load overview:', error);
            }
        }

        async function loadStudents() {
            try {
                const users = await apiCall('/admin/users');
                const students = users.filter(u => u.role !== 'admin');

                // Try to get course overview for progress info
                let courseOverview = [];
                try {
                    courseOverview = await apiCall('/admin/course-overview');
                } catch (e) {
                    console.log('Course overview not available');
                }

                const tbody = document.getElementById('studentsTableBody');
                tbody.innerHTML = students.length > 0 
                    ? students.map(s => {
                        const progress = courseOverview.find(c => c.user_id === s.id);
                        const classesCompleted = progress ? (progress.classes_completed || 0) : 0;
                        const currentClass = progress ? (progress.current_class || 1) : 1;
                        
                        return `
                        <tr>
                            <td>${s.name}</td>
                            <td>${s.email}</td>
                            <td><span class="badge ${s.is_active ? 'badge-success' : 'badge-danger'}">${s.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <span class="badge badge-info">Class ${currentClass}</span>
                                <small style="color:#666;">(${classesCompleted}/8 done)</small>
                            </td>
                            <td>${new Date(s.created_at).toLocaleDateString()}</td>
                            <td class="actions">
                                <button class="btn btn-sm btn-secondary" onclick="editStudent(${s.id}, '${s.name.replace(/'/g, "\\'")}', '${s.email}', ${s.is_active})">Edit</button>
                                <button class="btn btn-sm btn-warning" onclick="generateResetCode(${s.id}, '${s.email}')">Reset PW</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteStudent(${s.id}, '${s.name.replace(/'/g, "\\'")}')">Delete</button>
                            </td>
                        </tr>
                    `}).join('')
                    : '<tr><td colspan="6" class="empty-state">No students yet. Add your first student!</td></tr>';
            } catch (error) {
                console.error('Failed to load students:', error);
            }
        }

        // ==================== COURSE PROGRESS ====================

        async function loadCourseOverview() {
            try {
                const overview = await apiCall('/admin/course-overview');
                
                const tbody = document.getElementById('courseOverviewBody');
                tbody.innerHTML = overview.length > 0 
                    ? overview.map(s => {
                        const accuracy = s.total_questions > 0 
                            ? Math.round((s.total_score / s.total_questions) * 100) 
                            : 0;
                        return `
                        <tr>
                            <td><strong>${s.name}</strong><br><small>${s.email}</small></td>
                            <td><span class="badge badge-info">Class ${s.current_class || 1}</span></td>
                            <td>${s.classes_completed || 0} / 8</td>
                            <td>${s.total_questions > 0 ? `${s.total_score}/${s.total_questions} (${accuracy}%)` : '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="selectCourseStudent(${s.user_id})">View / Manage</button>
                            </td>
                        </tr>
                    `}).join('')
                    : '<tr><td colspan="5" class="empty-state">No students enrolled yet</td></tr>';
            } catch (error) {
                console.error('Failed to load course overview:', error);
                document.getElementById('courseOverviewBody').innerHTML = 
                    '<tr><td colspan="5" class="empty-state">Error loading data</td></tr>';
            }
        }

        function selectCourseStudent(studentId) {
            document.getElementById('courseStudentSelector').value = studentId;
            loadStudentCourseProgress();
        }

        async function loadStudentCourseProgress() {
            const studentId = document.getElementById('courseStudentSelector').value;
            
            if (!studentId) {
                document.getElementById('studentCourseDetail').style.display = 'none';
                document.getElementById('courseOverviewCard').style.display = 'block';
                return;
            }

            document.getElementById('studentCourseDetail').style.display = 'block';
            document.getElementById('courseOverviewCard').style.display = 'none';

            // Get student name
            const student = allStudentsList.find(s => s.id == studentId);
            document.getElementById('selectedStudentName').textContent = student ? student.name : 'Student';

            try {
                // Load class progress
                const progress = await apiCall(`/admin/users/${studentId}/course-progress`);
                
                // Render class cards
                const grid = document.getElementById('classProgressGrid');
                grid.innerHTML = [1,2,3,4,5,6,7,8].map(num => {
                    const classProgress = progress.find(p => p.class_number === num) || {};
                    const isUnlocked = classProgress.is_unlocked || false;
                    const isCompleted = classProgress.is_completed || false;
                    const unlockedBy = classProgress.unlocked_by || '';
                    
                    let statusClass = 'locked';
                    let statusText = 'üîí Locked';
                    let actionBtn = `<button class="unlock-btn" onclick="unlockClass(${studentId}, ${num})">Unlock</button>`;
                    
                    if (isCompleted) {
                        statusClass = 'completed';
                        statusText = '‚úì Completed';
                        actionBtn = `<button class="lock-btn" onclick="lockClass(${studentId}, ${num})" ${num === 1 ? 'disabled' : ''}>Lock</button>`;
                    } else if (isUnlocked) {
                        statusClass = 'unlocked';
                        statusText = '‚óã In Progress';
                        if (unlockedBy === 'admin') statusText += ' (Admin)';
                        actionBtn = `<button class="lock-btn" onclick="lockClass(${studentId}, ${num})" ${num === 1 ? 'disabled' : ''}>Lock</button>`;
                    }
                    
                    return `
                        <div class="class-progress-card ${statusClass}">
                            <div class="class-num">Class ${num}</div>
                            <div class="class-status">${statusText}</div>
                            <div class="class-actions">${actionBtn}</div>
                        </div>
                    `;
                }).join('');

                // Load homework drills
                const drills = await apiCall(`/admin/users/${studentId}/homework-drills`);
                
                const drillsBody = document.getElementById('homeworkDrillsBody');
                drillsBody.innerHTML = drills.length > 0 
                    ? drills.map(d => `
                        <tr>
                            <td>Class ${d.class_number}</td>
                            <td>Section ${d.section_number}</td>
                            <td><span class="badge ${d.drill_type === 'timed' ? 'badge-warning' : d.drill_type === 'test' ? 'badge-info' : 'badge-success'}">${d.drill_type}</span></td>
                            <td><strong>${d.score}</strong> / ${d.total_questions}</td>
                            <td>${d.time_taken_seconds ? formatTime(d.time_taken_seconds) : '-'}</td>
                            <td>${new Date(d.completed_at).toLocaleString()}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="6" class="empty-state">No homework drills completed yet</td></tr>';

            } catch (error) {
                console.error('Failed to load student course progress:', error);
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        async function unlockClass(studentId, classNumber) {
            try {
                await apiCall(`/admin/users/${studentId}/unlock-class`, {
                    method: 'POST',
                    body: JSON.stringify({ class_number: classNumber })
                });
                alert(`Class ${classNumber} unlocked successfully!`);
                loadStudentCourseProgress();
            } catch (error) {
                alert('Error unlocking class: ' + error.message);
            }
        }

        async function lockClass(studentId, classNumber) {
            if (!confirm(`Are you sure you want to lock Class ${classNumber}? The student will lose access.`)) {
                return;
            }
            try {
                await apiCall(`/admin/users/${studentId}/lock-class`, {
                    method: 'POST',
                    body: JSON.stringify({ class_number: classNumber })
                });
                alert(`Class ${classNumber} locked.`);
                loadStudentCourseProgress();
            } catch (error) {
                alert('Error locking class: ' + error.message);
            }
        }

        // ==================== QUESTIONS ====================

        async function loadQuestions() {
            try {
                const topicId = document.getElementById('topicFilter').value;
                const setType = document.getElementById('setTypeFilter').value;
                
                let endpoint = '/admin/questions?';
                if (topicId) endpoint += `topic_id=${topicId}&`;
                if (setType) endpoint += `set_type=${setType}`;

                const questions = await apiCall(endpoint);
                document.getElementById('questionCount').textContent = questions.length;

                const tbody = document.getElementById('questionsTableBody');
                tbody.innerHTML = questions.length > 0 
                    ? questions.map(q => `
                        <tr>
                            <td>${q.topic_name}</td>
                            <td><span class="badge ${q.set_type === 'timed' ? 'badge-warning' : 'badge-success'}">${q.set_type}</span></td>
                            <td>${q.question_number}</td>
                            <td>${q.question_text.substring(0, 50)}...</td>
                            <td><strong>${q.correct_answer}</strong></td>
                            <td class="actions">
                                <button class="btn btn-sm btn-secondary" onclick="editQuestion(${q.id})">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteQuestion(${q.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="6" class="empty-state">No questions yet. Add your first question!</td></tr>';
            } catch (error) {
                console.error('Failed to load questions:', error);
            }
        }

        // ==================== ATTEMPTS ====================

        let allAttempts = [];
        let allTopicsList = [];

        async function loadAttempts() {
            try {
                allAttempts = await apiCall('/admin/attempts');
                allTopicsList = await apiCall('/admin/topics');

                const tbody = document.getElementById('attemptsTableBody');
                tbody.innerHTML = allAttempts.length > 0 
                    ? allAttempts.map(a => `
                        <tr>
                            <td>${a.student_name}<br><small>${a.student_email}</small></td>
                            <td>${a.topic_name}</td>
                            <td><span class="badge ${a.set_type === 'timed' ? 'badge-warning' : 'badge-success'}">${a.set_type}</span></td>
                            <td>${a.score !== null ? `<strong>${a.score}</strong>/15` : '<em>In Progress</em>'}</td>
                            <td>${new Date(a.started_at).toLocaleString()}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="viewAttempt(${a.id})">View</button>
                            </td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="6" class="empty-state">No attempts yet</td></tr>';
            } catch (error) {
                console.error('Failed to load attempts:', error);
            }
        }

        function loadStudentProgress() {
            const studentId = document.getElementById('studentSelector').value;
            
            if (!studentId) {
                document.getElementById('studentOverview').style.display = 'none';
                document.getElementById('allAttemptsCard').style.display = 'block';
                return;
            }

            document.getElementById('studentOverview').style.display = 'block';
            document.getElementById('allAttemptsCard').style.display = 'none';

            // Filter attempts for selected student
            const studentAttempts = allAttempts.filter(a => a.user_id == studentId);
            const completedAttempts = studentAttempts.filter(a => a.score !== null);

            // Calculate stats
            const totalAttempts = completedAttempts.length;
            const avgScore = totalAttempts > 0 
                ? Math.round((completedAttempts.reduce((sum, a) => sum + a.score, 0) / totalAttempts / 15) * 100) 
                : 0;
            const topicsStarted = new Set(studentAttempts.map(a => a.topic_id)).size;
            const bestScore = completedAttempts.length > 0 
                ? Math.max(...completedAttempts.map(a => a.score)) 
                : 0;

            document.getElementById('statTotalAttempts').textContent = totalAttempts;
            document.getElementById('statAvgScore').textContent = avgScore + '%';
            document.getElementById('statTopicsStarted').textContent = topicsStarted + '/10';
            document.getElementById('statBestScore').textContent = bestScore + '/15';

            // Build topic-wise progress
            const topicProgress = allTopicsList.map(topic => {
                const topicAttempts = completedAttempts.filter(a => a.topic_id === topic.id);
                const untimedAttempts = topicAttempts.filter(a => a.set_type === 'untimed');
                const timedAttempts = topicAttempts.filter(a => a.set_type === 'timed');
                
                const untimedBest = untimedAttempts.length > 0 ? Math.max(...untimedAttempts.map(a => a.score)) : null;
                const timedBest = timedAttempts.length > 0 ? Math.max(...timedAttempts.map(a => a.score)) : null;
                
                const maxPossible = 30;
                const achieved = (untimedBest || 0) + (timedBest || 0);
                const progressPercent = Math.round((achieved / maxPossible) * 100);

                return {
                    ...topic,
                    untimedBest,
                    untimedCount: untimedAttempts.length,
                    timedBest,
                    timedCount: timedAttempts.length,
                    progressPercent
                };
            });

            const topicBody = document.getElementById('topicProgressBody');
            topicBody.innerHTML = topicProgress.map(t => `
                <tr>
                    <td><strong>${t.name}</strong></td>
                    <td>${t.untimedBest !== null ? `<span class="badge badge-success">${t.untimedBest}/15</span>` : '<span style="color:#999;">-</span>'}</td>
                    <td>${t.untimedCount}</td>
                    <td>${t.timedBest !== null ? `<span class="badge badge-warning">${t.timedBest}/15</span>` : '<span style="color:#999;">-</span>'}</td>
                    <td>${t.timedCount}</td>
                    <td>
                        <div style="background: #eee; border-radius: 10px; height: 20px; width: 100%; overflow: hidden;">
                            <div style="background: ${t.progressPercent >= 70 ? '#28a745' : t.progressPercent >= 40 ? '#ffc107' : '#dc3545'}; height: 100%; width: ${t.progressPercent}%; transition: width 0.3s;"></div>
                        </div>
                        <small style="color: #666;">${t.progressPercent}%</small>
                    </td>
                </tr>
            `).join('');

            const studentAttemptsBody = document.getElementById('studentAttemptsBody');
            studentAttemptsBody.innerHTML = studentAttempts.length > 0
                ? studentAttempts.slice(0, 20).map(a => `
                    <tr>
                        <td>${a.topic_name}</td>
                        <td><span class="badge ${a.set_type === 'timed' ? 'badge-warning' : 'badge-success'}">${a.set_type}</span></td>
                        <td>${a.score !== null ? `<strong>${a.score}</strong>/15` : '<em>In Progress</em>'}</td>
                        <td>${new Date(a.started_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="viewAttempt(${a.id})">View</button>
                        </td>
                    </tr>
                `).join('')
                : '<tr><td colspan="5" class="empty-state">No attempts yet</td></tr>';
        }

        // ==================== MODALS ====================

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAddStudentModal() {
            document.getElementById('studentModalTitle').textContent = 'Add Student';
            document.getElementById('studentId').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentEmail').value = '';
            document.getElementById('studentPassword').value = '';
            document.getElementById('studentPassword').required = true;
            document.getElementById('passwordHint').textContent = '(required)';
            document.getElementById('statusGroup').style.display = 'none';
            document.getElementById('studentModal').style.display = 'flex';
        }

        function editStudent(id, name, email, isActive) {
            document.getElementById('studentModalTitle').textContent = 'Edit Student';
            document.getElementById('studentId').value = id;
            document.getElementById('studentName').value = name;
            document.getElementById('studentEmail').value = email;
            document.getElementById('studentPassword').value = '';
            document.getElementById('studentPassword').required = false;
            document.getElementById('passwordHint').textContent = '(leave blank to keep current)';
            document.getElementById('studentStatus').value = isActive.toString();
            document.getElementById('statusGroup').style.display = 'block';
            document.getElementById('studentModal').style.display = 'flex';
        }

        document.getElementById('studentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('studentId').value;
            const name = document.getElementById('studentName').value;
            const email = document.getElementById('studentEmail').value;
            const password = document.getElementById('studentPassword').value;
            const isActive = document.getElementById('studentStatus').value === 'true';

            try {
                if (id) {
                    const body = { name, is_active: isActive };
                    if (password) body.password = password;
                    await apiCall(`/admin/users/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(body)
                    });
                } else {
                    await apiCall('/admin/users', {
                        method: 'POST',
                        body: JSON.stringify({ name, email, password })
                    });
                }
                closeModal('studentModal');
                loadStudents();
                loadStudentsList();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        async function deleteStudent(id, name) {
            if (confirm(`Are you sure you want to delete ${name}?`)) {
                try {
                    await apiCall(`/admin/users/${id}`, { method: 'DELETE' });
                    loadStudents();
                    loadStudentsList();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        function showAddQuestionModal() {
            document.getElementById('questionModalTitle').textContent = 'Add Question';
            document.getElementById('questionForm').reset();
            document.getElementById('questionId').value = '';
            document.getElementById('questionModal').style.display = 'flex';
        }

        let allQuestions = [];
        async function editQuestion(id) {
            try {
                if (allQuestions.length === 0) {
                    allQuestions = await apiCall('/admin/questions');
                }
                const q = allQuestions.find(q => q.id === id);
                if (!q) return;

                document.getElementById('questionModalTitle').textContent = 'Edit Question';
                document.getElementById('questionId').value = q.id;
                document.getElementById('questionTopic').value = q.topic_id;
                document.getElementById('questionSetType').value = q.set_type;
                document.getElementById('questionNumber').value = q.question_number;
                document.getElementById('questionPassage').value = q.passage || '';
                document.getElementById('questionText').value = q.question_text;
                document.getElementById('optionA').value = q.option_a;
                document.getElementById('optionB').value = q.option_b;
                document.getElementById('optionC').value = q.option_c;
                document.getElementById('optionD').value = q.option_d;
                document.getElementById('correctAnswer').value = q.correct_answer;
                document.getElementById('questionExplanation').value = q.explanation || '';
                document.getElementById('questionModal').style.display = 'flex';
            } catch (error) {
                alert('Error loading question: ' + error.message);
            }
        }

        document.getElementById('questionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('questionId').value;
            const body = {
                topic_id: document.getElementById('questionTopic').value,
                set_type: document.getElementById('questionSetType').value,
                question_number: parseInt(document.getElementById('questionNumber').value),
                passage: document.getElementById('questionPassage').value || null,
                question_text: document.getElementById('questionText').value,
                option_a: document.getElementById('optionA').value,
                option_b: document.getElementById('optionB').value,
                option_c: document.getElementById('optionC').value,
                option_d: document.getElementById('optionD').value,
                correct_answer: document.getElementById('correctAnswer').value,
                explanation: document.getElementById('questionExplanation').value || null
            };

            try {
                if (id) {
                    await apiCall(`/admin/questions/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(body)
                    });
                } else {
                    await apiCall('/admin/questions', {
                        method: 'POST',
                        body: JSON.stringify(body)
                    });
                }
                closeModal('questionModal');
                allQuestions = [];
                loadQuestions();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        async function deleteQuestion(id) {
            if (confirm('Are you sure you want to delete this question?')) {
                try {
                    await apiCall(`/admin/questions/${id}`, { method: 'DELETE' });
                    allQuestions = [];
                    loadQuestions();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        async function viewAttempt(id) {
            try {
                const responses = await apiCall(`/admin/attempts/${id}/responses`);
                
                const html = responses.length > 0 
                    ? `<table>
                        <thead><tr><th>Q#</th><th>Selected</th><th>Correct</th><th>Result</th></tr></thead>
                        <tbody>
                            ${responses.map((r, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${r.selected_answer || '-'}</td>
                                    <td>${r.correct_answer}</td>
                                    <td><span class="badge ${r.is_correct ? 'badge-success' : 'badge-danger'}">${r.is_correct ? '‚úì' : '‚úó'}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`
                    : '<p class="empty-state">No responses recorded</p>';
                
                document.getElementById('attemptDetails').innerHTML = html;
                document.getElementById('attemptModal').style.display = 'flex';
            } catch (error) {
                alert('Error loading attempt: ' + error.message);
            }
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // Bulk upload functions
        function downloadTemplate(event) {
            event.preventDefault();
            
            const templateData = [
                ['topic_name', 'set_type', 'question_number', 'passage', 'question_text', 'option_a', 'option_b', 'option_c', 'option_d', 'correct_answer', 'explanation'],
                ['Words in Context', 'untimed', 1, 'The artist\'s innovative approach challenged conventions.', 'In this context, "innovative" most nearly means', 'traditional', 'groundbreaking', 'expensive', 'complicated', 'B', 'Innovative means introducing new ideas, similar to groundbreaking.'],
                ['Words in Context', 'untimed', 2, '', 'Sample question text here', 'Option A', 'Option B', 'Option C', 'Option D', 'A', 'Explanation here'],
            ];
            
            let csvContent = templateData.map(row => 
                row.map(cell => {
                    if (typeof cell === 'string' && (cell.includes(',') || cell.includes('"') || cell.includes('\n'))) {
                        return '"' + cell.replace(/"/g, '""') + '"';
                    }
                    return cell;
                }).join(',')
            ).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'questions_template.csv';
            link.click();
        }

        async function bulkUpload() {
            const fileInput = document.getElementById('bulkUploadFile');
            const statusDiv = document.getElementById('uploadStatus');
            
            if (!fileInput.files || !fileInput.files[0]) {
                alert('Please select a file first');
                return;
            }
            
            const file = fileInput.files[0];
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p style="color: #666;">‚è≥ Uploading and processing...</p>';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const res = await fetch(`${API_URL}/admin/questions/bulk`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Upload failed');
                }
                
                let statusHtml = `<p style="color: #28a745;">‚úÖ ${data.message}</p>`;
                
                if (data.errors && data.errors.length > 0) {
                    statusHtml += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                        <strong>Warnings:</strong><br>
                        ${data.errors.slice(0, 10).map(e => `‚Ä¢ ${e}`).join('<br>')}
                        ${data.errors.length > 10 ? `<br>... and ${data.errors.length - 10} more` : ''}
                    </div>`;
                }
                
                statusDiv.innerHTML = statusHtml;
                fileInput.value = '';
                allQuestions = [];
                loadQuestions();
                
            } catch (error) {
                statusDiv.innerHTML = `<p style="color: #dc3545;">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function generateResetCode(userId, email) {
            try {
                const result = await apiCall(`/admin/users/${userId}/reset-code`, {
                    method: 'POST'
                });
                
                alert(`‚úÖ Reset Code Generated!\n\nStudent: ${result.student.name}\nEmail: ${email}\n\nüîë Reset Code: ${result.reset_code}\n\n‚è∞ Expires in: ${result.expires_in}\n\nShare this code with the student. They can use it on the login page by clicking "Forgot Password".`);
            } catch (error) {
                alert('Error generating reset code: ' + error.message);
            }
        }
    </script>
</body>
</html>
